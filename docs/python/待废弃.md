# 待废弃<a name="ZH-CN_TOPIC_0000002407891549"></a>

## 产品支持情况<a name="section8178181118225"></a>

<a name="zh-cn_topic_0000002374411996_table38301303189"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000002374411996_row20831180131817"><th class="cellrowborder" valign="top" width="57.99999999999999%" id="mcps1.1.3.1.1"><p id="zh-cn_topic_0000002374411996_p1883113061818"><a name="zh-cn_topic_0000002374411996_p1883113061818"></a><a name="zh-cn_topic_0000002374411996_p1883113061818"></a><span id="zh-cn_topic_0000002374411996_ph20833205312295"><a name="zh-cn_topic_0000002374411996_ph20833205312295"></a><a name="zh-cn_topic_0000002374411996_ph20833205312295"></a>产品</span></p>
</th>
<th class="cellrowborder" align="center" valign="top" width="42%" id="mcps1.1.3.1.2"><p id="zh-cn_topic_0000002374411996_p783113012187"><a name="zh-cn_topic_0000002374411996_p783113012187"></a><a name="zh-cn_topic_0000002374411996_p783113012187"></a>是否支持</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000002374411996_row220181016240"><td class="cellrowborder" valign="top" width="57.99999999999999%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002374411996_p48327011813"><a name="zh-cn_topic_0000002374411996_p48327011813"></a><a name="zh-cn_topic_0000002374411996_p48327011813"></a><span id="zh-cn_topic_0000002374411996_ph583230201815"><a name="zh-cn_topic_0000002374411996_ph583230201815"></a><a name="zh-cn_topic_0000002374411996_ph583230201815"></a><term id="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term1253731311225"><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term1253731311225"></a><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term1253731311225"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term12835255145414"><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term12835255145414"></a><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term12835255145414"></a>Atlas A3 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="42%" headers="mcps1.1.3.1.2 "><p id="zh-cn_topic_0000002374411996_p7948163910184"><a name="zh-cn_topic_0000002374411996_p7948163910184"></a><a name="zh-cn_topic_0000002374411996_p7948163910184"></a>√</p>
</td>
</tr>
<tr id="zh-cn_topic_0000002374411996_row173226882415"><td class="cellrowborder" valign="top" width="57.99999999999999%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002374411996_p14832120181815"><a name="zh-cn_topic_0000002374411996_p14832120181815"></a><a name="zh-cn_topic_0000002374411996_p14832120181815"></a><span id="zh-cn_topic_0000002374411996_ph980713477118"><a name="zh-cn_topic_0000002374411996_ph980713477118"></a><a name="zh-cn_topic_0000002374411996_ph980713477118"></a><term id="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term454024162214"><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term454024162214"></a><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term454024162214"></a>Atlas 800I A2 推理产品</term>/A200I A2 Box 异构组件</span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="42%" headers="mcps1.1.3.1.2 "><p id="zh-cn_topic_0000002374411996_p19948143911820"><a name="zh-cn_topic_0000002374411996_p19948143911820"></a><a name="zh-cn_topic_0000002374411996_p19948143911820"></a>√</p>
</td>
</tr>
<tr id="zh-cn_topic_0000002374411996_row15882185517522"><td class="cellrowborder" valign="top" width="57.99999999999999%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002374411996_p1682479135314"><a name="zh-cn_topic_0000002374411996_p1682479135314"></a><a name="zh-cn_topic_0000002374411996_p1682479135314"></a><span id="zh-cn_topic_0000002374411996_ph14880920154918"><a name="zh-cn_topic_0000002374411996_ph14880920154918"></a><a name="zh-cn_topic_0000002374411996_ph14880920154918"></a><term id="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term16184138172215"><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term16184138172215"></a><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term16184138172215"></a>Atlas A2 训练系列产品</term></span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="42%" headers="mcps1.1.3.1.2 "><p id="zh-cn_topic_0000002374411996_p578615025316"><a name="zh-cn_topic_0000002374411996_p578615025316"></a><a name="zh-cn_topic_0000002374411996_p578615025316"></a>x</p>
</td>
</tr>
<tr id="zh-cn_topic_0000002374411996_row103361763242"><td class="cellrowborder" valign="top" width="57.99999999999999%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002374411996_p1983180181813"><a name="zh-cn_topic_0000002374411996_p1983180181813"></a><a name="zh-cn_topic_0000002374411996_p1983180181813"></a><span id="zh-cn_topic_0000002374411996_ph783112021813"><a name="zh-cn_topic_0000002374411996_ph783112021813"></a><a name="zh-cn_topic_0000002374411996_ph783112021813"></a><term id="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term354143892110"><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term354143892110"></a><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term354143892110"></a>Atlas 200I/500 A2 推理产品</term></span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="42%" headers="mcps1.1.3.1.2 "><p id="zh-cn_topic_0000002374411996_p1695483941817"><a name="zh-cn_topic_0000002374411996_p1695483941817"></a><a name="zh-cn_topic_0000002374411996_p1695483941817"></a>x</p>
</td>
</tr>
<tr id="zh-cn_topic_0000002374411996_row18403312418"><td class="cellrowborder" valign="top" width="57.99999999999999%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002374411996_p78319051815"><a name="zh-cn_topic_0000002374411996_p78319051815"></a><a name="zh-cn_topic_0000002374411996_p78319051815"></a><span id="zh-cn_topic_0000002374411996_ph1383116081815"><a name="zh-cn_topic_0000002374411996_ph1383116081815"></a><a name="zh-cn_topic_0000002374411996_ph1383116081815"></a><term id="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term4363218112215"><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term4363218112215"></a><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term4363218112215"></a>Atlas 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="42%" headers="mcps1.1.3.1.2 "><p id="zh-cn_topic_0000002374411996_p1695443971810"><a name="zh-cn_topic_0000002374411996_p1695443971810"></a><a name="zh-cn_topic_0000002374411996_p1695443971810"></a>x</p>
</td>
</tr>
<tr id="zh-cn_topic_0000002374411996_row17253142120252"><td class="cellrowborder" valign="top" width="57.99999999999999%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002374411996_p38313021813"><a name="zh-cn_topic_0000002374411996_p38313021813"></a><a name="zh-cn_topic_0000002374411996_p38313021813"></a><span id="zh-cn_topic_0000002374411996_ph58317041819"><a name="zh-cn_topic_0000002374411996_ph58317041819"></a><a name="zh-cn_topic_0000002374411996_ph58317041819"></a><term id="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term71949488213"><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term71949488213"></a><a name="zh-cn_topic_0000002374411996_zh-cn_topic_0000001312391781_term71949488213"></a>Atlas 训练系列产品</term></span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="42%" headers="mcps1.1.3.1.2 "><p id="zh-cn_topic_0000002374411996_p395243920186"><a name="zh-cn_topic_0000002374411996_p395243920186"></a><a name="zh-cn_topic_0000002374411996_p395243920186"></a>x</p>
</td>
</tr>
</tbody>
</table>

## CacheManager
### allocate\_cache<a name="ZH-CN_TOPIC_0000002407891465"></a>
**函数功能**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section3870635"></a>

分配Cache，Cache分配成功后，会同时被cache\_id与cache\_keys引用，只有当这些引用都解除后，cache所占用的资源才会实际释放。

cache\_id的引用需通过deallocate\_cache解除，cache\_keys的引用则可以通过以下2种方式解除。

-   Decode调用pull\_cache或push\_cache接口成功后解除。
-   PROMPT调用remove\_cache\_key接口时解除。

**函数原型**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section24431028171314"></a>

```
allocate_cache(cache_desc: CacheDesc, cache_keys: Union[Tuple[CacheKey], List[CacheKey]] = ())
```

**参数说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section34835721"></a>

<a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_table2051894852017"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row4558174815206"><th class="cellrowborder" valign="top" width="22.220000000000002%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a>参数名称</strong></p>
</th>
<th class="cellrowborder" valign="top" width="35.89%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a>数据类型</p>
</th>
<th class="cellrowborder" valign="top" width="41.89%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a>取值说明</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row35581048202018"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p6621349454"><a name="p6621349454"></a><a name="p6621349454"></a>cache_desc</p>
</td>
<td class="cellrowborder" valign="top" width="35.89%" headers="mcps1.1.4.1.2 "><p id="p9541205974512"><a name="p9541205974512"></a><a name="p9541205974512"></a>CacheDesc</a></p>
</td>
<td class="cellrowborder" valign="top" width="41.89%" headers="mcps1.1.4.1.3 "><p id="p7172700591"><a name="p7172700591"></a><a name="p7172700591"></a>Cache的描述。</p>
</td>
</tr>
<tr id="row99821205619"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p1599201212562"><a name="p1599201212562"></a><a name="p1599201212562"></a>cache_keys</p>
</td>
<td class="cellrowborder" valign="top" width="35.89%" headers="mcps1.1.4.1.2 "><p id="p1597465633314"><a name="p1597465633314"></a><a name="p1597465633314"></a>Union[Tuple[CacheKey</a>], List[CacheKey</a>]]</p>
</td>
<td class="cellrowborder" valign="top" width="41.89%" headers="mcps1.1.4.1.3 "><p id="p194801239195713"><a name="p194801239195713"></a><a name="p194801239195713"></a>Cache的索引。</p>
</td>
</tr>
</tbody>
</table>

**调用示例**<a name="section17821439839"></a>

```
from llm_datadist import *
...
cache_desc = CacheDesc(1, [2, 1024 * 1024], DataType.DT_FLOAT16)
cache_keys = [CacheKey(1, req_id=1), CacheKey(1, req_id=2)]
cache = cache_manager.allocate_cache(cache_desc, cache_keys)
```

**返回值**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section45086037"></a>

正常情况下返回Cache。

传入数据类型错误情况下会抛出TypeError或ValueError异常。

如果cache\_keys中包含了分配内存时绑定的CacheKey，则抛出LLMException异常。

执行时间超过sync\_kv\_timeout配置会抛出LLMException异常。

**约束说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section28090371"></a>

-   传入cache\_keys时，如果Cache的batch size\>1，则需要提供相同数量的CacheKey，分别引用一组kv tensor。
-   如果当次推理的batch未占用满，即存在无效batch\_index，则需要插入特殊的CacheKey（将req\_id设置为UINT64\_MAX）占位，如果空闲的batch\_index在末尾，则可以省略。
-   如果cache\_keys存在重复，则最后一个生效。
-   调用该接口接口前需要先配置内存池。
### deallocate\_cache<a name="ZH-CN_TOPIC_0000002407891537"></a>
**函数功能**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section3870635"></a>

释放Cache。

如果该Cache在被分配时关联了CacheKey，则实际的释放会延后到所有的CacheKey被拉取或执行了remove\_cache\_key。

**函数原型**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section24431028171314"></a>

```
deallocate_cache(cache: Cache)
```

**参数说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section34835721"></a>

<a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_table2051894852017"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row4558174815206"><th class="cellrowborder" valign="top" width="22.220000000000002%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a>参数名称</strong></p>
</th>
<th class="cellrowborder" valign="top" width="35.89%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a>数据类型</p>
</th>
<th class="cellrowborder" valign="top" width="41.89%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a>取值说明</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row35581048202018"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p6621349454"><a name="p6621349454"></a><a name="p6621349454"></a>cache</p>
</td>
<td class="cellrowborder" valign="top" width="35.89%" headers="mcps1.1.4.1.2 "><p id="p9541205974512"><a name="p9541205974512"></a><a name="p9541205974512"></a>Cache</a></p>
</td>
<td class="cellrowborder" valign="top" width="41.89%" headers="mcps1.1.4.1.3 "><p id="p7172700591"><a name="p7172700591"></a><a name="p7172700591"></a>要释放的Cache。</p>
</td>
</tr>
</tbody>
</table>

**调用示例**<a name="section17821439839"></a>

```
from llm_datadist import *
...
cache_manager.deallocate_cache(cache)
```

**返回值**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section45086037"></a>

正常情况下无返回值。

传入数据类型错误情况下会抛出TypeError或ValueError异常。

执行时间超过sync\_kv\_timeout配置会抛出LLMException异常。

**约束说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section28090371"></a>

如果Cache不存在或已释放，该操作为空操作。
### remove\_cache\_key<a name="ZH-CN_TOPIC_0000002374412024"></a>
**函数功能**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section3870635"></a>

移除CacheKey。

移除CacheKey后，该Cache将无法再被pull\_cache拉取。

**函数原型**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section24431028171314"></a>

```
remove_cache_key(cache_key: CacheKey)
```

**参数说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section34835721"></a>

<a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_table2051894852017"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row4558174815206"><th class="cellrowborder" valign="top" width="22.220000000000002%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a>参数名称</strong></p>
</th>
<th class="cellrowborder" valign="top" width="35.870000000000005%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a>数据类型</p>
</th>
<th class="cellrowborder" valign="top" width="41.91%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a>取值说明</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row35581048202018"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p6621349454"><a name="p6621349454"></a><a name="p6621349454"></a>cache_key</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p9541205974512"><a name="p9541205974512"></a><a name="p9541205974512"></a>CacheKey</a></p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p7172700591"><a name="p7172700591"></a><a name="p7172700591"></a>需要被移除的CacheKey。</p>
</td>
</tr>
</tbody>
</table>

**调用示例**<a name="section17821439839"></a>

```
from llm_datadist import *
...
cache_keys = [CacheKey(1, req_id=1), CacheKey(1, req_id=2)]
cache_manager.remove_cache_key(cache_keys[0])
cache_manager.remove_cache_key(cache_keys[1])
```

**返回值**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section45086037"></a>

正常情况下无返回值。

参数错误可能抛出TypeError或ValueError。

执行时间超过sync\_kv\_timeout配置会抛出LLMException异常。

**约束说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section28090371"></a>

如果CacheKey不存在或已移除，该操作为空操作。
### copy\_cache<a name="ZH-CN_TOPIC_0000002374412032"></a>
**函数功能**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section3870635"></a>

拷贝Cache。

**函数原型**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section24431028171314"></a>

```
copy_cache(dst: Cache, src: Cache, dst_batch_index: int = 0, src_batch_index: int = 0, offset: int = 0, size: int = -1, req_id: Optional[int] = None)
```

**参数说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section34835721"></a>

<a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_table2051894852017"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row4558174815206"><th class="cellrowborder" valign="top" width="22.220000000000002%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a>参数名称</strong></p>
</th>
<th class="cellrowborder" valign="top" width="35.870000000000005%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a>数据类型</p>
</th>
<th class="cellrowborder" valign="top" width="41.91%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a>取值说明</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row35581048202018"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p6621349454"><a name="p6621349454"></a><a name="p6621349454"></a>dst</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p9541205974512"><a name="p9541205974512"></a><a name="p9541205974512"></a>Cache</a></p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p7172700591"><a name="p7172700591"></a><a name="p7172700591"></a>目标Cache。</p>
</td>
</tr>
<tr id="row0710153012620"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p971011302618"><a name="p971011302618"></a><a name="p971011302618"></a>src</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p271013306616"><a name="p271013306616"></a><a name="p271013306616"></a>Cache</a></p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p13710163018615"><a name="p13710163018615"></a><a name="p13710163018615"></a>源Cache。</p>
</td>
</tr>
<tr id="row10353734760"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p16353173413610"><a name="p16353173413610"></a><a name="p16353173413610"></a>dst_batch_index</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p133531834363"><a name="p133531834363"></a><a name="p133531834363"></a>int</p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p73541534663"><a name="p73541534663"></a><a name="p73541534663"></a>目标Cache的batch_index，默认为0。</p>
</td>
</tr>
<tr id="row9752193819616"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p47521238465"><a name="p47521238465"></a><a name="p47521238465"></a>src_batch_index</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p7752838763"><a name="p7752838763"></a><a name="p7752838763"></a>int</p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p37521383618"><a name="p37521383618"></a><a name="p37521383618"></a>源Cache的batch_index，默认为0。</p>
</td>
</tr>
<tr id="row1212210371466"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p5122637161"><a name="p5122637161"></a><a name="p5122637161"></a>offset</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p2122437867"><a name="p2122437867"></a><a name="p2122437867"></a>int</p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p101222373610"><a name="p101222373610"></a><a name="p101222373610"></a>每个tensor的偏移，默认为0。</p>
</td>
</tr>
<tr id="row167993218616"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p967923214612"><a name="p967923214612"></a><a name="p967923214612"></a>size</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p196791532563"><a name="p196791532563"></a><a name="p196791532563"></a>int</p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p37063585311"><a name="p37063585311"></a><a name="p37063585311"></a>设置为&gt;0的整数，表示要拷贝的大小。</p>
<p id="p136582910548"><a name="p136582910548"></a><a name="p136582910548"></a>或设置为-1，表示完整拷贝。</p>
<p id="p7374185016429"><a name="p7374185016429"></a><a name="p7374185016429"></a>默认为-1。</p>
</td>
</tr>
<tr id="row551844124413"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p6959114194514"><a name="p6959114194514"></a><a name="p6959114194514"></a>req_id</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p9959649456"><a name="p9959649456"></a><a name="p9959649456"></a>Optional[int]</p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p1651447444"><a name="p1651447444"></a><a name="p1651447444"></a>本次调用关联的req_id，如果设置了该参数则本地调用相关的维测日志中会打印该req_id</p>
<p id="p5220161815469"><a name="p5220161815469"></a><a name="p5220161815469"></a>默认为None</p>
</td>
</tr>
</tbody>
</table>

**调用示例**<a name="section17821439839"></a>

```
from llm_datadist import *
...
cache_manager.copy_cache(dst_cache, src_cache, 0, 1, 0, 128)
```

**返回值**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section45086037"></a>

正常情况下无返回值。

传入数据类型错误情况下会抛出TypeError或ValueError异常。

执行时间超过sync\_kv\_timeout配置会抛出LLMException异常。

**约束说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section28090371"></a>

源Cache和目的Cahce的CacheDesc需要匹配。

### allocate\_blocks\_cache<a name="ZH-CN_TOPIC_0000002407891565"></a>
**函数功能**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section3870635"></a>

PagedAttention场景下，分配多个blocks的Cache，Cache分配成功后，可通过deallocate\_blocks\_cache释放内存。

**函数原型**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section24431028171314"></a>

```
allocate_blocks_cache(cache_desc: CacheDesc, blocks_cache_key: Optional[BlocksCacheKey] = None)
```

**参数说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section34835721"></a>

<a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_table2051894852017"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row4558174815206"><th class="cellrowborder" valign="top" width="22.220000000000002%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a>参数名称</strong></p>
</th>
<th class="cellrowborder" valign="top" width="35.89%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a>数据类型</p>
</th>
<th class="cellrowborder" valign="top" width="41.89%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a>取值说明</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row35581048202018"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p6621349454"><a name="p6621349454"></a><a name="p6621349454"></a>cache_desc</p>
</td>
<td class="cellrowborder" valign="top" width="35.89%" headers="mcps1.1.4.1.2 "><p id="p9541205974512"><a name="p9541205974512"></a><a name="p9541205974512"></a>CacheDesc</a></p>
</td>
<td class="cellrowborder" valign="top" width="41.89%" headers="mcps1.1.4.1.3 "><p id="p7172700591"><a name="p7172700591"></a><a name="p7172700591"></a>Cache的描述。</p>
</td>
</tr>
<tr id="row99821205619"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p1599201212562"><a name="p1599201212562"></a><a name="p1599201212562"></a>blocks_cache_key</p>
</td>
<td class="cellrowborder" valign="top" width="35.89%" headers="mcps1.1.4.1.2 "><p id="p149931218561"><a name="p149931218561"></a><a name="p149931218561"></a>Optional[BlocksCacheKey</a>]</p>
</td>
<td class="cellrowborder" valign="top" width="41.89%" headers="mcps1.1.4.1.3 "><p id="p194801239195713"><a name="p194801239195713"></a><a name="p194801239195713"></a>索引一个blocks cache。</p>
</td>
</tr>
</tbody>
</table>

**调用示例**<a name="section17821439839"></a>

```
from llm_datadist import *
...
blocks_cache_key = BlocksCacheKey(1, 0)
blocks_cache = cache_manager.allocate_blocks_cache(cache_desc, blocks_cache_key)
```

**返回值**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section45086037"></a>

正常情况下返回Cache。

传入数据类型错误情况下会抛出TypeError或ValueError异常。

执行时间超过sync\_kv\_timeout配置会抛出LLMException异常。

**约束说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section28090371"></a>

需要先配置内存池才能使用。
### deallocate\_blocks\_cache<a name="ZH-CN_TOPIC_0000002374411988"></a>
**函数功能**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section3870635"></a>

分配Cache，Cache分配成功后，会同时被cache\_id与cache\_keys引用，只有当这些引用都解除后，cache所占用的资源才会实际释放。

cache\_id的引用需通过deallocate\_cache解除，cache\_keys的引用则可以通过以下2种方式解除。

-   Decode调用pull\_cache或push\_cache接口成功后解除。
-   PROMPT调用remove\_cache\_key接口时解除。

**函数原型**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section24431028171314"></a>

```
allocate_cache(cache_desc: CacheDesc, cache_keys: Union[Tuple[CacheKey], List[CacheKey]] = ())
```

**参数说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section34835721"></a>

<a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_table2051894852017"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row4558174815206"><th class="cellrowborder" valign="top" width="22.220000000000002%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a>参数名称</strong></p>
</th>
<th class="cellrowborder" valign="top" width="35.89%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a>数据类型</p>
</th>
<th class="cellrowborder" valign="top" width="41.89%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a>取值说明</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row35581048202018"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p6621349454"><a name="p6621349454"></a><a name="p6621349454"></a>cache_desc</p>
</td>
<td class="cellrowborder" valign="top" width="35.89%" headers="mcps1.1.4.1.2 "><p id="p9541205974512"><a name="p9541205974512"></a><a name="p9541205974512"></a>CacheDesc</a></p>
</td>
<td class="cellrowborder" valign="top" width="41.89%" headers="mcps1.1.4.1.3 "><p id="p7172700591"><a name="p7172700591"></a><a name="p7172700591"></a>Cache的描述。</p>
</td>
</tr>
<tr id="row99821205619"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p1599201212562"><a name="p1599201212562"></a><a name="p1599201212562"></a>cache_keys</p>
</td>
<td class="cellrowborder" valign="top" width="35.89%" headers="mcps1.1.4.1.2 "><p id="p1597465633314"><a name="p1597465633314"></a><a name="p1597465633314"></a>Union[Tuple[CacheKey</a>], List[CacheKey</a>]]</p>
</td>
<td class="cellrowborder" valign="top" width="41.89%" headers="mcps1.1.4.1.3 "><p id="p194801239195713"><a name="p194801239195713"></a><a name="p194801239195713"></a>Cache的索引。</p>
</td>
</tr>
</tbody>
</table>

**调用示例**<a name="section17821439839"></a>

```
from llm_datadist import *
...
cache_desc = CacheDesc(1, [2, 1024 * 1024], DataType.DT_FLOAT16)
cache_keys = [CacheKey(1, req_id=1), CacheKey(1, req_id=2)]
cache = cache_manager.allocate_cache(cache_desc, cache_keys)
```

**返回值**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section45086037"></a>

正常情况下返回Cache。

传入数据类型错误情况下会抛出TypeError或ValueError异常。

如果cache\_keys中包含了分配内存时绑定的CacheKey，则抛出LLMException异常。

执行时间超过sync\_kv\_timeout配置会抛出LLMException异常。

**约束说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section28090371"></a>

-   传入cache\_keys时，如果Cache的batch size\>1，则需要提供相同数量的CacheKey，分别引用一组kv tensor。
-   如果当次推理的batch未占用满，即存在无效batch\_index，则需要插入特殊的CacheKey（将req\_id设置为UINT64\_MAX）占位，如果空闲的batch\_index在末尾，则可以省略。
-   如果cache\_keys存在重复，则最后一个生效。
-   调用该接口接口前需要先配置内存池。
### copy\_blocks<a name="ZH-CN_TOPIC_0000002407891569"></a>
**函数功能**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section3870635"></a>

PagedAttention场景下，拷贝block。

**函数原型**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section24431028171314"></a>

```
copy_blocks(cache: Cache, copy_block_info: Dict[int, List[int]])
```

**参数说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section34835721"></a>

<a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_table2051894852017"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row4558174815206"><th class="cellrowborder" valign="top" width="22.220000000000002%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a>参数名称</strong></p>
</th>
<th class="cellrowborder" valign="top" width="35.870000000000005%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a>数据类型</p>
</th>
<th class="cellrowborder" valign="top" width="41.91%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a>取值说明</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row35581048202018"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p6621349454"><a name="p6621349454"></a><a name="p6621349454"></a>cache</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p9541205974512"><a name="p9541205974512"></a><a name="p9541205974512"></a>Cache</a></p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p7172700591"><a name="p7172700591"></a><a name="p7172700591"></a>目标Cache。</p>
</td>
</tr>
<tr id="row0710153012620"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p971011302618"><a name="p971011302618"></a><a name="p971011302618"></a>copy_block_info</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p271013306616"><a name="p271013306616"></a><a name="p271013306616"></a>Dict[int, List[int]]</p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p13710163018615"><a name="p13710163018615"></a><a name="p13710163018615"></a>dict里面内容代表（原始block index，目标block index列表）。</p>
</td>
</tr>
</tbody>
</table>

**调用示例**<a name="section17821439839"></a>

```
cache_manager.copy_blocks(cache, {1: [2,3]})
```

**返回值**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section45086037"></a>

正常情况下无返回值。

传入数据类型错误情况下会抛出TypeError或ValueError异常。

执行时间超过sync\_kv\_timeout配置会抛出LLMException异常。

**约束说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section28090371"></a>

无
### swap\_blocks<a name="ZH-CN_TOPIC_0000002408011713"></a>
**函数功能**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section3870635"></a>

对cpu\_cache和npu\_cache进行换入换出。

对于swap out功能，该接口启用了4个线程执行并行任务；对于swap in功能，该接口启用了1个d2d线程。为了性能稳定，建议进行进程绑核。

swap in功能分为H2D和D2D两个阶段，为了保障性能，该接口申请了4个block大小的buffer用作流水拷贝，所以建议预留出对应的Device内存，防止出现OOM。

**函数原型**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section24431028171314"></a>

```
swap_blocks(src_cache: Cache, dst_cache: Cache, src_to_dst: Dict[int, int])
```

**参数说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section34835721"></a>

<a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_table2051894852017"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row4558174815206"><th class="cellrowborder" valign="top" width="22.220000000000002%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a>参数名称</strong></p>
</th>
<th class="cellrowborder" valign="top" width="35.870000000000005%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a>数据类型</p>
</th>
<th class="cellrowborder" valign="top" width="41.91%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a>取值说明</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row35581048202018"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p6621349454"><a name="p6621349454"></a><a name="p6621349454"></a>src_cache</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p9541205974512"><a name="p9541205974512"></a><a name="p9541205974512"></a>Cache</a></p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p7172700591"><a name="p7172700591"></a><a name="p7172700591"></a>源Cache。</p>
</td>
</tr>
<tr id="row0710153012620"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p971011302618"><a name="p971011302618"></a><a name="p971011302618"></a>dst_cache</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p271013306616"><a name="p271013306616"></a><a name="p271013306616"></a>Cache</a></p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p13710163018615"><a name="p13710163018615"></a><a name="p13710163018615"></a>目标Cache。</p>
</td>
</tr>
<tr id="row16899125121211"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p0899165171217"><a name="p0899165171217"></a><a name="p0899165171217"></a>src_to_dst</p>
</td>
<td class="cellrowborder" valign="top" width="35.870000000000005%" headers="mcps1.1.4.1.2 "><p id="p089965151218"><a name="p089965151218"></a><a name="p089965151218"></a>Dict[int, int]</p>
</td>
<td class="cellrowborder" valign="top" width="41.91%" headers="mcps1.1.4.1.3 "><p id="p108993520127"><a name="p108993520127"></a><a name="p108993520127"></a>dict里面内容代表（原始block index，目标block index）</p>
</td>
</tr>
</tbody>
</table>

**调用示例**<a name="section17821439839"></a>

```
from llm_datadist import Cache
npu_cache = cache_manager.allocate_blocks_cache(npu_cache_desc, npu_cache_key)
cpu_cache = Cache.create_cpu_cache(cpu_cache_desc, cpu_addrs) # cpu_addrs来自创建的cpu tensors
# swap in
cache_manager.swap_blocks(cpu_cache, npu_cache, {1:2, 3:4})
# swap out
cache_manager.swap_blocks(npu_cache, cpu_cache, {1:2, 3:4})
```

**返回值**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section45086037"></a>

正常情况下无返回值。

传入数据类型错误，src和dst不匹配情况下会抛出TypeError或ValueError异常。

传入参数为None，会抛出AttributeError异常。

**约束说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section28090371"></a>

仅支持PagedAttention场景使用。
## LLMConfig
### mem\_pool\_cfg<a name="ZH-CN_TOPIC_0000002408011613"></a>
**函数功能**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section3870635"></a>

配置内存池相关配置项。

**函数原型**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section24431028171314"></a>

```
mem_pool_cfg(mem_pool_cfg)
```

**参数说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section34835721"></a>

<a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_table2051894852017"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row4558174815206"><th class="cellrowborder" valign="top" width="22.220000000000002%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a>参数名称</strong></p>
</th>
<th class="cellrowborder" valign="top" width="15.06%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a>数据类型</p>
</th>
<th class="cellrowborder" valign="top" width="62.72%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a>取值说明</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row35581048202018"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p6621349454"><a name="p6621349454"></a><a name="p6621349454"></a>mem_pool_cfg</p>
</td>
<td class="cellrowborder" valign="top" width="15.06%" headers="mcps1.1.4.1.2 "><p id="p9541205974512"><a name="p9541205974512"></a><a name="p9541205974512"></a>string</p>
</td>
<td class="cellrowborder" valign="top" width="62.72%" headers="mcps1.1.4.1.3 "><p id="p19907288261"><a name="p19907288261"></a><a name="p19907288261"></a>json数组格式字符串，包含memory_size，page_shift。</p>
</td>
</tr>
</tbody>
</table>

<a name="table16292457124212"></a>
<table><thead align="left"><tr id="row13292057114211"><th class="cellrowborder" valign="top" width="27.63%" id="mcps1.1.4.1.1"><p id="p16292205764216"><a name="p16292205764216"></a><a name="p16292205764216"></a>配置项</p>
</th>
<th class="cellrowborder" valign="top" width="27.87%" id="mcps1.1.4.1.2"><p id="p429210575426"><a name="p429210575426"></a><a name="p429210575426"></a>可选/必选</p>
</th>
<th class="cellrowborder" valign="top" width="44.5%" id="mcps1.1.4.1.3"><p id="p17292185719427"><a name="p17292185719427"></a><a name="p17292185719427"></a>描述</p>
</th>
</tr>
</thead>
<tbody><tr id="row429295718421"><td class="cellrowborder" valign="top" width="27.63%" headers="mcps1.1.4.1.1 "><p id="p029205794213"><a name="p029205794213"></a><a name="p029205794213"></a>memory_size</p>
</td>
<td class="cellrowborder" valign="top" width="27.87%" headers="mcps1.1.4.1.2 "><p id="p42925575423"><a name="p42925575423"></a><a name="p42925575423"></a>必选</p>
</td>
<td class="cellrowborder" valign="top" width="44.5%" headers="mcps1.1.4.1.3 "><p id="p6292125719420"><a name="p6292125719420"></a><a name="p6292125719420"></a>当前内存池的大小，类型为int，大于0，单位为Byte。</p>
</td>
</tr>
<tr id="row1650419315282"><td class="cellrowborder" valign="top" width="27.63%" headers="mcps1.1.4.1.1 "><p id="p95041835282"><a name="p95041835282"></a><a name="p95041835282"></a>page_shift</p>
</td>
<td class="cellrowborder" valign="top" width="27.87%" headers="mcps1.1.4.1.2 "><p id="p55041333285"><a name="p55041333285"></a><a name="p55041333285"></a>可选</p>
</td>
<td class="cellrowborder" valign="top" width="44.5%" headers="mcps1.1.4.1.3 "><p id="p3916941400"><a name="p3916941400"></a><a name="p3916941400"></a>page_size的位移量，用于计算page_size。分配内存时会对齐到page_size的倍数，需要根据实际场景设置为合适的大小。</p>
<p id="p544273810304"><a name="p544273810304"></a><a name="p544273810304"></a>类型为int，取值范围为[10, 31)。</p>
<p id="p1450419332814"><a name="p1450419332814"></a><a name="p1450419332814"></a>例如：page_shift = 16时，page_size为1&lt;&lt;16=65536。</p>
<p id="p1594413134299"><a name="p1594413134299"></a><a name="p1594413134299"></a>默认值为16。</p>
</td>
</tr>
</tbody>
</table>

**调用示例**<a name="section17821439839"></a>

```
from llm_datadist import LLMConfig
llm_config = LLMConfig()
llm_config.mem_pool_cfg= "{\"memory_size\": 18737418240, \"page_shift\": 16}"
```

**返回值**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section45086037"></a>

正常情况下无返回值。

参数错误可能抛出TypeError或ValueError。

**约束说明**<a name="section4233173018"></a>

无
### host\_mem\_pool\_cfg<a name="ZH-CN_TOPIC_0000002374252064"></a>
**函数功能**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section3870635"></a>

配置Host内存池相关配置项。

**函数原型**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section24431028171314"></a>

```
host_mem_pool_cfg(host_mem_pool_cfg)
```

**参数说明**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section34835721"></a>

<a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_table2051894852017"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row4558174815206"><th class="cellrowborder" valign="top" width="22.220000000000002%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p255884814201"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b145581148152018"></a>参数名称</strong></p>
</th>
<th class="cellrowborder" valign="top" width="15.06%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p537710614477"></a>数据类型</p>
</th>
<th class="cellrowborder" valign="top" width="62.72%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_p14558184812200"></a><strong id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a><a name="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_b19165651193118"></a>取值说明</strong></p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000001417673572_zh-cn_topic_0000001359609816_row35581048202018"><td class="cellrowborder" valign="top" width="22.220000000000002%" headers="mcps1.1.4.1.1 "><p id="p1595964613515"><a name="p1595964613515"></a><a name="p1595964613515"></a>host_mem_pool_cfg</p>
</td>
<td class="cellrowborder" valign="top" width="15.06%" headers="mcps1.1.4.1.2 "><p id="p3959546113517"><a name="p3959546113517"></a><a name="p3959546113517"></a>string</p>
</td>
<td class="cellrowborder" valign="top" width="62.72%" headers="mcps1.1.4.1.3 "><p id="p3959346113517"><a name="p3959346113517"></a><a name="p3959346113517"></a>json数组格式字符串，包含memory_size，page_shift。</p>
</td>
</tr>
</tbody>
</table>

<a name="table16292457124212"></a>
<table><thead align="left"><tr id="row13292057114211"><th class="cellrowborder" valign="top" width="27.63%" id="mcps1.1.4.1.1"><p id="p16292205764216"><a name="p16292205764216"></a><a name="p16292205764216"></a>配置项</p>
</th>
<th class="cellrowborder" valign="top" width="27.87%" id="mcps1.1.4.1.2"><p id="p429210575426"><a name="p429210575426"></a><a name="p429210575426"></a>可选/必选</p>
</th>
<th class="cellrowborder" valign="top" width="44.5%" id="mcps1.1.4.1.3"><p id="p17292185719427"><a name="p17292185719427"></a><a name="p17292185719427"></a>描述</p>
</th>
</tr>
</thead>
<tbody><tr id="row429295718421"><td class="cellrowborder" valign="top" width="27.63%" headers="mcps1.1.4.1.1 "><p id="p251215014361"><a name="p251215014361"></a><a name="p251215014361"></a>memory_size</p>
</td>
<td class="cellrowborder" valign="top" width="27.87%" headers="mcps1.1.4.1.2 "><p id="p14512120113619"><a name="p14512120113619"></a><a name="p14512120113619"></a>必选</p>
</td>
<td class="cellrowborder" valign="top" width="44.5%" headers="mcps1.1.4.1.3 "><p id="p1251218015369"><a name="p1251218015369"></a><a name="p1251218015369"></a>当前内存池的大小，类型为int，大于0，单位为Byte。</p>
</td>
</tr>
<tr id="row1650419315282"><td class="cellrowborder" valign="top" width="27.63%" headers="mcps1.1.4.1.1 "><p id="p8512150173613"><a name="p8512150173613"></a><a name="p8512150173613"></a>page_shift</p>
</td>
<td class="cellrowborder" valign="top" width="27.87%" headers="mcps1.1.4.1.2 "><p id="p95129012365"><a name="p95129012365"></a><a name="p95129012365"></a>可选</p>
</td>
<td class="cellrowborder" valign="top" width="44.5%" headers="mcps1.1.4.1.3 "><p id="p3512130103614"><a name="p3512130103614"></a><a name="p3512130103614"></a>page_size的位移量，用于计算page_size。分配内存时会对齐到page_size的倍数，需要根据实际场景设置为合适的大小。</p>
<p id="p115121204368"><a name="p115121204368"></a><a name="p115121204368"></a>类型为int，取值范围为[10, 31)。</p>
<p id="p10512100365"><a name="p10512100365"></a><a name="p10512100365"></a>例如：page_shift = 16时，page_size为1&lt;&lt;16=65536。</p>
<p id="p351219014368"><a name="p351219014368"></a><a name="p351219014368"></a>默认值为16。</p>
</td>
</tr>
</tbody>
</table>

**调用示例**<a name="section17821439839"></a>

```
from llm_datadist import LLMConfig
llm_config = LLMConfig()
llm_config.host_mem_pool_cfg= "{\"memory_size\": 18737418240, \"page_shift\": 16}"
```

**返回值**<a name="zh-cn_topic_0000001481404214_zh-cn_topic_0000001488949573_zh-cn_topic_0000001357384997_zh-cn_topic_0000001312399929_section45086037"></a>

正常情况下无返回值。

参数错误可能抛出TypeError或ValueError。

**约束说明**<a name="section4233173018"></a>

Host内存池最大不超过20G。









